"use strict";!function(d,s){d.helpers=d.helpers||{},d.helpers.getRandomString=function(e){e=e||5;for(var t="",n="abcdefghijklmnopqrstuvwxyz0123456789",r=0;r<e;r++)t+=n.charAt(Math.floor(Math.random()*n.length));return t},d.helpers.getRequest=function(e){return e.data=e.data||{},e.beforeSend||(e.beforeSend=function(e){e.setRequestHeader("X-WP-Nonce",d.restNonce)}),e.data._wpnonce||(e.data._wpnonce=d.restNonce),s.ajax(e)},d.helpers.reinitCodemirror=function(e){var t=s(e);t.next(".CodeMirror").remove();var n=wp.codeEditor.initialize(t.attr("id"),CMB2.codeEditorArgs(t.data("codeeditor")));n.codemirror.on("change",function(e){return n.codemirror.save()})};var e={tabs:function(){var o=s(".wp-quiz-tab-wrapper");o.length&&(o.each(function(){var e=s(this),n=e.parent(),r=e.find("> a"),a=n.find("> .wp-quiz-tab-content-wrapper > .wp-quiz-setting-panel"),i=e.data("active-class")||"active",t=s("#message.updated").length?localStorage.getItem(n.attr("id")):null;s("#auto_draft").length&&(t=""),r.on("click",function(){var e=s(this),t=e.attr("href");return r.removeClass(i),a.hide(),e.addClass(i),s(t).show(),localStorage.setItem(n.attr("id"),t),s(document).trigger("wp-quiz-activated-tab",e),!1}),null!==t&&(t=s('a[href="'+t+'"]',e)).length?t.trigger("click"):r.eq(0).trigger("click"),o.next().css("min-height",e.outerHeight())}),o.on("click","> .button-primary",function(){return s(".cmb-form > .button-primary").trigger("click"),!1}))},dependencyManager:function(){var t=this,e=s(".cmb-form, .wp-quiz-meta-box-wrap");s(".cmb-repeat-group-wrap",e).each(function(){var e=s(this),t=e.next(".wp-quiz-cmb-dependency.hidden");t.length&&e.find("> .cmb-td").append(t)}),s(".wp-quiz-cmb-dependency",e).each(function(){t.loopDependencies(s(this))}),s("input, select",e).on("change",function(){var e=s(this).attr("name");s('span[data-field="'+e+'"]').each(function(){t.loopDependencies(s(this).closest(".wp-quiz-cmb-dependency"))})})},checkDependency:function(e,t,n){return"string"==typeof t&&t.includes(",")&&"="===n?t.includes(e):"string"==typeof t&&t.includes(",")&&"!="===n?!t.includes(e):"="===n&&e===t||("=="===n&&e===t||(">="===n&&t<=e||("<="===n&&e<=t||(">"===n&&t<e||("<"===n&&e<t||"!="===n&&e!==t)))))},loopDependencies:function(e){var o,c=this,d=e.attr("data-relation");e.find("span").each(function(){var e=s(this),t=e.attr("data-value"),n=e.attr("data-comparison"),r=s("[name='"+e.attr("data-field")+"']"),a=r.val();r.is(":radio")&&(a=r.filter(":checked").val()),r.is(":checkbox")&&(a=r.is(":checked"));var i=c.checkDependency(a,t,n);if("or"===d&&i)return!(o=!0);"and"===d&&(o=(void 0===o||o)&&i)});var t=e.closest(".wp-quiz-cmb-group");t.length||(t=e.closest(".cmb-row:not(.cmb-repeat-row):not(.empty-row)")),o?t.slideDown(300):t.hide()},dismissNotices:function(){s(document).on("click",".wp-quiz-notice .notice-dismiss",function(e){var t=s(this).closest(".wp-quiz-notice").attr("data-option-name");s.ajax({url:ajaxurl,type:"post",data:{action:"wp_quiz_dismiss_notice",option:t}})})},fixTextareaCode:function(){s(".cmb-repeat-table").each(function(e,t){s(t).on("cmb2_add_row",function(e,t){var n=t.prev(".cmb-repeat-row").find(".cmb2-textarea-code");n.length&&d.helpers.reinitCodemirror(n)})}),s("#show_ads2").on("change",function(e){e.currentTarget.checked&&s("#ad_codes_repeat .cmb2-textarea-code").each(function(e,t){d.helpers.reinitCodemirror(t)})}),s("#wp_quiz_show_ads2").on("change",function(e){e.currentTarget.checked&&s("#wp_quiz_ad_codes_repeat .cmb2-textarea-code").each(function(e,t){d.helpers.reinitCodemirror(t)})}),s(document).on("wp-quiz-activated-tab",function(e){s("#ad_codes_repeat .cmb2-textarea-code, #wp_quiz_ad_codes_repeat .cmb2-textarea-code").each(function(e,t){d.helpers.reinitCodemirror(t)})}),s("#ad_codes_repeat .cmb-row.empty-row.hidden .cmb2-textarea-code").val(""),s("#ad_codes_repeat .cmb-row.empty-row.hidden .cmb-td br").remove(),s("#ad_codes_repeat .cmb-row.empty-row.hidden .cmb-td font").remove(),s(document).on("click","#submit-cmb",function(){s("#ad_codes_repeat .cmb-row.empty-row.hidden").remove()})},showPlayerTrackingDetail:function(){s(document).on("click",".wp-quiz-toggle-player-tracking-data",function(e){e.preventDefault();var t=e.currentTarget.dataset.id,n=s(e.currentTarget).next(".wp-quiz-tracking"),r=s(e.currentTarget).closest("tr");r.next(".tr-player-tracking-"+t).length?r.next(".tr-player-tracking-"+t).toggle():r.after(s('<tr class="tr-player-tracking-'+t+'">').append(s('<td colspan="'+(r.children("td").length+1)+'">').append(n)))})},selectAll:function(){s("#selectall").on("change",function(e){s(e.currentTarget).closest("table").find(":checkbox").prop("checked",e.currentTarget.checked)})},importQuizzes:function(){function t(e){e.preventDefault();var t=s(e.currentTarget);t.find(".spinner").css("visibility","visible"),t.find(":submit").prop("disabled",!0);var n={quizzes:window.wqImportQuizzes.quizzes,download_images:s("#wq-download-images").prop("checked"),force_new:s("#wq-force-new-quizzes").prop("checked")},r=d.restUrl+"wp-quiz/v2/admin/import-quizzes",a=d.helpers.getRequest({url:r,method:"POST",data:n});a.done(function(e){!function t(){var e=d.restUrl+"wp-quiz/v2/admin/import-quizzes-progress",n=d.helpers.getRequest({url:e,method:"GET"});n.done(function(e){s("#import-done").text(i-e.remain),0<e.remain?t():s("#wq-import-progress").fadeOut("fast",function(){s("#wq-import-done").fadeIn("fast")})}),n.fail(function(e){console.error(e)})}(),t.fadeOut("fast",function(){s("#wq-import-progress").fadeIn("fast")})}),a.fail(function(e){console.error(e)})}var i=parseInt(s("#import-total").text());s(document).on("submit","#wq-import-options",function(e){return t(e)})},aweberOptions:function(){var c=this,e=s(".cmb-type-aweber");e.length&&e.each(function(e,t){var n=s(t).find(".aweber-wrapper"),r=n.find(".aweber-connect-button"),a=n.find(".aweber-disconnect-button"),i=n.find(".aweber-verification-code"),o=n.find(".aweber-refresh-lists-button");r.on("click",function(e){e.preventDefault(),s(c).prop("disabled",!0);var t=i.val();t||i.focus(),d.helpers.getRequest({url:ajaxurl,method:"POST",data:{action:"wp_quiz_connect_aweber",token:t}}).done(function(e){s(c).prop("disabled",!1),e.success?(o.trigger("click"),n.addClass("connected")):alert(e.data)})}),a.on("click",function(e){e.preventDefault(),s(c).prop("disabled",!0),d.helpers.getRequest({url:ajaxurl,method:"POST",data:{action:"wp_quiz_disconnect_aweber"}}).done(function(e){s(c).prop("disabled",!1),e.success?n.removeClass("connected"):alert(e.data)})}),o.on("click",function(e){e.preventDefault(),o.prop("disabled",!0),d.helpers.getRequest({url:ajaxurl,method:"POST",data:{action:"wp_quiz_refresh_aweber_lists"}}).done(function(e){if(!e.success)return alert(e.data),void o.prop("disabled",!1);var t="";e.data.forEach(function(e){t+='<option value="'+e.id+'">'+e.name+"</option>"}),n.find("#aweber_listid option:not(:eq(0))").remove(),n.find("#aweber_listid").append(t),o.prop("disabled",!1)})})})},exportSelectedPlayersAndLeads:function(){var e=s("#wq-export-button"),t=s("#wq-export-form"),r=s("#wq-export-ids"),a=s("#the-list .check-column :checkbox");if(t.length&&r.length&&a.length){var n=function(){var n,e=(n=[],a.each(function(e,t){t.checked&&n.push(t.value)}),n);r.val(e.join(","))};e.on("click",function(e){return t.submit()}),a.on("change",function(e){return n()}),s("#cb-select-all-1").on("change",function(e){return n()}),s("#cb-select-all-2").on("change",function(e){return n()})}},ready:function(){this.tabs(),this.dependencyManager(),this.dismissNotices(),this.fixTextareaCode(),this.showPlayerTrackingDetail(),this.selectAll(),this.importQuizzes(),this.aweberOptions(),this.exportSelectedPlayersAndLeads()}};s(document).ready(function(){e.ready()})}(wpQuizAdmin,jQuery);